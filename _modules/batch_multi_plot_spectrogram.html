<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>batch_multi_plot_spectrogram &#8212; Configurable Spectrograms  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for batch_multi_plot_spectrogram</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Provides batch spectrogram plotting utilities.</span>
<span class="sd">    Should work with CDFs like those from FAST (see batch_multi_plot_FAST_spectrograms.py) but should also be flexible with other data</span>

<span class="sd">    Assumed folder layout is {CDF_DATA_DIRECTORY}/year/month</span>
<span class="sd">    Filenames in the month folders assumed to be in the following formats:</span>
<span class="sd">        {??}_{??}_{??}_{instrument}_{timestamp}_{orbit}_v02.cdf      (known &quot;instruments&quot; are ees, eeb, ies, or ieb)</span>
<span class="sd">        {??}_{??}_orb_{orbit}_{??}.cdf</span>
<span class="sd">    Examples:</span>
<span class="sd">        FAST_data/2000/01/fa_esa_l2_eeb_20000101001737_13312_v02.cdf</span>
<span class="sd">        FAST_data/2000/01/fa_k0_orb_13312_v01.cdf</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__authors__</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Ev Hansen&quot;</span><span class="p">]</span>
<span class="n">__contact__</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ephansen+gh@terpmail.umd.edu&quot;</span>

<span class="n">__credits__</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;Ev Hansen&quot;</span><span class="p">,</span> <span class="s2">&quot;Python code&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;Emma Mirizio&quot;</span><span class="p">,</span> <span class="s2">&quot;Co-Mentor&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;Marilia Samara&quot;</span><span class="p">,</span> <span class="s2">&quot;Co-Mentor&quot;</span><span class="p">],</span>
<span class="p">]</span>

<span class="n">__date__</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2025-08-13&quot;</span>
<span class="n">__status__</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span>
<span class="n">__version__</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0.0.1&quot;</span>
<span class="n">__license__</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GPL-3.0&quot;</span>

<span class="c1"># Main imports for CDF data and plotting</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cdflib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;Agg&quot;</span><span class="p">)</span>  <span class="c1"># Use non-interactive backend for batch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.figure</span><span class="w"> </span><span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backends.backend_agg</span><span class="w"> </span><span class="kn">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="kn">import</span> <span class="n">date2num</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">_pylab_helpers</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>

<span class="c1"># garbage collection, parallel processing, and profiling</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>


<span class="c1"># Section: Constants and Configuration</span>
<span class="c1"># Directory containing CDF data files</span>
<span class="n">CDF_DATA_DIRECTORY</span> <span class="o">=</span> <span class="s2">&quot;./FAST_data/&quot;</span>
<span class="c1"># List of variable names expected in CDF files</span>
<span class="n">CDF_VARIABLE_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time_unix&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="s2">&quot;pitch_angle&quot;</span><span class="p">]</span>
<span class="c1"># Function to collapse 3D data arrays to 2D (e.g., sum over axis)</span>
<span class="n">COLLAPSE_FUNCTION</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span>

<span class="c1"># Colormaps for different axis scaling combinations (colorblind-friendly and visually distinct)</span>
<span class="n">COLORMAP_LINEAR_Y_LINEAR_Z</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span>
<span class="n">COLORMAP_LINEAR_Y_LOG_Z</span> <span class="o">=</span> <span class="s2">&quot;cividis&quot;</span>
<span class="n">COLORMAP_LOG_Y_LINEAR_Z</span> <span class="o">=</span> <span class="s2">&quot;plasma&quot;</span>
<span class="n">COLORMAP_LOG_Y_LOG_Z</span> <span class="o">=</span> <span class="s2">&quot;inferno&quot;</span>

<span class="c1"># Plot configuration</span>
<span class="n">PLOT_FIGURE_WIDTH_INCHES</span> <span class="o">=</span> <span class="mf">6.25</span>
<span class="n">PLOT_FIGURE_HEIGHT_INCHES</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">TICK_LABEL_FONT_SIZE</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">AXIS_LABEL_FONT_SIZE</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">DEFAULT_ZOOM_WINDOW_MINUTES</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Default zoom window duration in minutes</span>
<span class="n">FILTERED_ORBITS_CSV_PATH</span> <span class="o">=</span> <span class="s2">&quot;./FAST_Cusp_Indices.csv&quot;</span>  <span class="c1"># Path to filtered cusp orbits CSV</span>
<span class="n">PLOTTING_PROGRESS_JSON_PATH</span> <span class="o">=</span> <span class="s2">&quot;./batch_multi_plot_progress.json&quot;</span>  <span class="c1"># Path to JSON for tracking plotting progress across sessions</span>
<span class="n">OUTPUT_BASE_DIRECTORY</span> <span class="o">=</span> <span class="s2">&quot;./plots/&quot;</span>  <span class="c1"># Parent directory to save plots</span>

<span class="c1"># Logfile configuration for batch restarts</span>
<span class="n">LOGFILE_DATETIME_PATH</span> <span class="o">=</span> <span class="s2">&quot;./batch_multi_plot_logfile_datetime.txt&quot;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">LOGFILE_DATETIME_PATH</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">LOGFILE_DATETIME_PATH</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">LOGFILE_DATETIME_STRING</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">LOGFILE_DATETIME_STRING</span><span class="p">:</span>
        <span class="n">LOGFILE_DATETIME_STRING</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">LOGFILE_DATETIME_PATH</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">LOGFILE_DATETIME_STRING</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">LOGFILE_DATETIME_STRING</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">LOGFILE_DATETIME_PATH</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">LOGFILE_DATETIME_STRING</span><span class="p">)</span>
<span class="n">LOGFILE_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./batch_multi_plot_log_</span><span class="si">{</span><span class="n">LOGFILE_DATETIME_STRING</span><span class="si">}</span><span class="s2">.log&quot;</span>

<span class="c1"># Pitch angle category definitions for spectrogram plots</span>
<span class="n">PITCH_ANGLE_CATEGORY_RANGES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;downgoing&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">330</span><span class="p">,</span> <span class="mi">360</span><span class="p">)],</span>
    <span class="s2">&quot;upgoing&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">210</span><span class="p">)],</span>
    <span class="s2">&quot;perpendicular&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">140</span><span class="p">),</span> <span class="p">(</span><span class="mi">210</span><span class="p">,</span> <span class="mi">330</span><span class="p">)],</span>
    <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)],</span>
<span class="p">}</span>

<span class="c1"># Global caches for batch optimization</span>
<span class="n">filtered_orbits_cache</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">orbit_column_cache</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">cdf_type_cache</span> <span class="o">=</span> <span class="p">{}</span>


<span class="c1"># Section: Functions</span>
<span class="c1"># Section: Utility Functions</span>
<div class="viewcode-block" id="load_filtered_orbits">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.load_filtered_orbits">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_filtered_orbits</span><span class="p">(</span><span class="n">csv_path</span><span class="o">=</span><span class="n">FILTERED_ORBITS_CSV_PATH</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the filtered orbits CSV with a simple cache.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    csv_path : str, default FILTERED_ORBITS_CSV_PATH</span>
<span class="sd">        Path to the filtered orbits TSV/CSV file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame or None</span>
<span class="sd">        DataFrame of filtered orbits, or ``None`` if loading fails.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    A module-level dictionary caches previously loaded DataFrames keyed by absolute</span>
<span class="sd">    path string to avoid repeated disk I/O in batch routines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">filtered_orbits_cache</span>
    <span class="k">if</span> <span class="n">csv_path</span> <span class="ow">in</span> <span class="n">filtered_orbits_cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">filtered_orbits_cache</span><span class="p">[</span><span class="n">csv_path</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">filtered_orbits_cache</span><span class="p">[</span><span class="n">csv_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span>
        <span class="k">return</span> <span class="n">dataframe</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading CSV </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<span class="c1"># Section: SIGINT Handling</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_terminate_all_child_processes</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attempt to terminate all child processes of this process.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses :mod:`psutil` (imported lazily) to enumerate child processes recursively</span>
<span class="sd">    and invoke ``terminate()`` on each. Exceptions during termination are suppressed</span>
<span class="sd">    because this function is used during best-effort shutdown handling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>

    <span class="n">current_process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">current_process</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">child_termination_exception</span><span class="p">:</span>
            <span class="c1"># Suppress individual child termination issues during shutdown.</span>
            <span class="c1"># Variable name intentionally descriptive for lint clarity.</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">child_termination_exception</span>  <span class="c1"># explicit no-op reference</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_sigint_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SIGINT handler to terminate children and exit promptly.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signum : int</span>
<span class="sd">        Signal number.</span>
<span class="sd">    frame : FrameType or None</span>
<span class="sd">        Current execution frame (unused).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;[INFO] SIGINT received. Terminating all child processes and exiting.&quot;</span><span class="p">)</span>
    <span class="n">_terminate_all_child_processes</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># Section: Logging</span>
<span class="n">_LOG_BUFFER</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list[tuple[str, str]]: buffered (level, message) entries</span>
<span class="n">_LOG_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># default batch size for buffered logging; configurable</span>


<div class="viewcode-block" id="configure_log_batch">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.configure_log_batch">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">configure_log_batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure buffered logging batch size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        Desired number of log records to accumulate before an automatic flush.</span>
<span class="sd">        Values less than 1 are coerced to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_LOG_BATCH_SIZE</span>
    <span class="n">_LOG_BATCH_SIZE</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">))</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_flush_log_buffer</span><span class="p">(</span><span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flush buffered log messages to disk.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    force : bool, default False</span>
<span class="sd">        If True, flush even if the current buffer length is below the configured</span>
<span class="sd">        batch size threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_LOG_BUFFER</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_LOG_BUFFER</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">_LOG_BATCH_SIZE</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">LOGFILE_PATH</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">logfile_out</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">_LOG_BUFFER</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                        <span class="n">logfile_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logfile_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">log_flush_exception</span><span class="p">:</span>
            <span class="c1"># Last-resort console output</span>
            <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Failed flushing log buffer: </span><span class="si">{</span><span class="n">log_flush_exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_LOG_BUFFER</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<div class="viewcode-block" id="log_message">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.log_message">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_message</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force_flush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Queue an informational log message.</span>

<span class="sd">    Messages are appended to an in-memory buffer; a flush occurs automatically</span>
<span class="sd">    once the configured batch size is reached or ``force_flush`` is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_LOG_BUFFER</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
    <span class="n">_flush_log_buffer</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force_flush</span><span class="p">)</span></div>



<div class="viewcode-block" id="log_error">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.log_error">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force_flush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Queue an error log message and echo to console immediately.&quot;&quot;&quot;</span>
    <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[ERROR] &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
    <span class="n">_LOG_BUFFER</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
    <span class="n">_flush_log_buffer</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force_flush</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_timestamps_for_orbit">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.get_timestamps_for_orbit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_timestamps_for_orbit</span><span class="p">(</span>
    <span class="n">filtered_orbits_dataframe</span><span class="p">,</span> <span class="n">orbit_number</span><span class="p">,</span> <span class="n">instrument_type</span><span class="p">,</span> <span class="n">time_unix_array</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute orbit boundary UNIX timestamps from filtered indices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filtered_orbits_dataframe : pandas.DataFrame</span>
<span class="sd">        DataFrame containing filtered orbits and min/max indices per instrument.</span>
<span class="sd">    orbit_number : int</span>
<span class="sd">        Orbit number to look up.</span>
<span class="sd">    instrument_type : str</span>
<span class="sd">        Instrument type identifier (e.g., ``&#39;ees&#39;``, ``&#39;ies&#39;``).</span>
<span class="sd">    time_unix_array : numpy.ndarray</span>
<span class="sd">        1D array of UNIX timestamps for the instrument.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of float</span>
<span class="sd">        Boundary UNIX timestamps for the orbit (one value for a degenerate span</span>
<span class="sd">        or two values for start/end). Returns an empty list on invalid indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">orbit_column_cache</span>
    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">filtered_orbits_dataframe</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">orbit_column_cache</span>
    <span class="k">if</span> <span class="n">dataframe</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">instrument_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">time_unix_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">dataframe</span><span class="p">),</span> <span class="n">instrument_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
        <span class="n">orbit_column</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;orbit&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">min_index_column</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="n">col</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="n">instrument_type</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;min index&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">max_index_column</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="n">col</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="n">instrument_type</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;max index&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">orbit_column</span><span class="p">,</span> <span class="n">min_index_column</span><span class="p">,</span> <span class="n">max_index_column</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">orbit_column</span><span class="p">,</span> <span class="n">min_index_column</span><span class="p">,</span> <span class="n">max_index_column</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">dataframe</span><span class="p">[</span><span class="n">orbit_column</span><span class="p">]</span> <span class="o">==</span> <span class="n">orbit_number</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">min_index</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">max_index</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">min_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_index</span><span class="p">)</span>
        <span class="n">max_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_index</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">orbit_index_cast_exception</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;[WARN] Non-integer indices found in orbit row, using 0.&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">orbit_index_cast_exception</span>  <span class="c1"># explicit no-op reference</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">min_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_index</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_unix_array</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">max_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_index</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_unix_array</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">min_index</span> <span class="o">==</span> <span class="n">max_index</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">time_unix_array</span><span class="p">[</span><span class="n">min_index</span><span class="p">])]</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">time_unix_array</span><span class="p">[</span><span class="n">min_index</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">time_unix_array</span><span class="p">[</span><span class="n">max_index</span><span class="p">])]</span></div>



<div class="viewcode-block" id="get_cdf_file_type">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.get_cdf_file_type">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_cdf_file_type</span><span class="p">(</span><span class="n">cdf_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infer instrument type from a CDF file path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cdf_file_path : str</span>
<span class="sd">        Path to the CDF file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or None</span>
<span class="sd">        Instrument type string (e.g., ``&#39;ees&#39;``), ``&#39;orb&#39;`` for orbit files, or ``None`` if not recognized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path_lower</span> <span class="o">=</span> <span class="n">cdf_file_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">instrument_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ees&quot;</span><span class="p">,</span> <span class="s2">&quot;eeb&quot;</span><span class="p">,</span> <span class="s2">&quot;ies&quot;</span><span class="p">,</span> <span class="s2">&quot;ieb&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;_orb_&quot;</span> <span class="ow">in</span> <span class="n">path_lower</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;orb&quot;</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">instrument_tags</span><span class="p">:</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_&quot;</span> <span class="ow">in</span> <span class="n">path_lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tag</span>
    <span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown CDF file type for path: </span><span class="si">{</span><span class="n">cdf_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="get_variable_shape">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.get_variable_shape">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_variable_shape</span><span class="p">(</span><span class="n">cdf_path</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the shape of a variable in a CDF file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cdf_path : str</span>
<span class="sd">        Path to the CDF file.</span>
<span class="sd">    variable_name : str</span>
<span class="sd">        Variable name to inspect.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple or None</span>
<span class="sd">        Variable shape tuple, or ``None`` if variable absent / not array or an error occurs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">cdf_type_cache</span>
    <span class="n">instrument_type</span> <span class="o">=</span> <span class="n">cdf_type_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cdf_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">instrument_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">instrument_type</span> <span class="o">=</span> <span class="n">get_cdf_file_type</span><span class="p">(</span><span class="n">cdf_path</span><span class="p">)</span>
        <span class="n">cdf_type_cache</span><span class="p">[</span><span class="n">cdf_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrument_type</span>
    <span class="k">if</span> <span class="n">instrument_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">instrument_type</span> <span class="o">==</span> <span class="s2">&quot;orb&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">cdflib</span><span class="o">.</span><span class="n">CDF</span><span class="p">(</span><span class="n">cdf_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">cdf</span><span class="p">:</span>
            <span class="n">variable_data</span> <span class="o">=</span> <span class="n">cdf</span><span class="o">.</span><span class="n">varget</span><span class="p">(</span><span class="n">variable_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">variable_data</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading </span><span class="si">{</span><span class="n">cdf_path</span><span class="si">}</span><span class="s2"> for variable </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="get_cdf_var_shapes">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.get_cdf_var_shapes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_cdf_var_shapes</span><span class="p">(</span>
    <span class="n">cdf_folder_path</span><span class="o">=</span><span class="n">CDF_DATA_DIRECTORY</span><span class="p">,</span> <span class="n">variable_names</span><span class="o">=</span><span class="n">CDF_VARIABLE_NAMES</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect shapes of variables across CDF files in a folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cdf_folder_path : str, default CDF_DATA_DIRECTORY</span>
<span class="sd">        Directory containing CDF files.</span>
<span class="sd">    variable_names : list of str, default CDF_VARIABLE_NAMES</span>
<span class="sd">        Variable names to inspect.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Mapping from variable name (str) to list of shape tuples (or None) per file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cdf_file_paths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">cdf_folder_path</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.[cC][dD][fF]&quot;</span><span class="p">)]</span>
    <span class="n">shapes_by_variable</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">variable_name</span> <span class="ow">in</span> <span class="n">variable_names</span><span class="p">:</span>
        <span class="n">shapes_by_variable</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cdf_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">cdf_file_paths</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Processing CDF files (</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">cdf_file_paths</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">shapes_by_variable</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">get_variable_shape</span><span class="p">(</span><span class="n">cdf_path</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">shapes_by_variable</span></div>



<div class="viewcode-block" id="close_all_axes_and_clear">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.close_all_axes_and_clear">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">close_all_axes_and_clear</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close axes/subplots and clear a figure to free memory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        Figure instance to clear and dispose.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Ensures axes are deleted, the canvas is closed/detached, and removes the figure</span>
<span class="sd">    from the global Gcf registry when possible to mitigate memory growth during</span>
<span class="sd">    large batch operations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">axis_close_error</span><span class="p">:</span>
            <span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing axis: </span><span class="si">{</span><span class="n">axis_close_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;canvas&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">canvas_close_error</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARN] Error closing canvas: </span><span class="si">{</span><span class="n">canvas_close_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">canvas_figure_clear_error</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[WARN] Error clearing canvas figure: </span><span class="si">{</span><span class="n">canvas_figure_clear_error</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fig</span><span class="o">.</span><span class="n">number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_pylab_helpers</span><span class="o">.</span><span class="n">Gcf</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">gcf_registry_error</span><span class="p">:</span>
        <span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error removing figure from Gcf registry: </span><span class="si">{</span><span class="n">gcf_registry_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1"># Section: Spectrogram Plotting</span>
<div class="viewcode-block" id="make_spectrogram">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.make_spectrogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_spectrogram</span><span class="p">(</span>
    <span class="n">x_axis_values</span><span class="p">,</span>
    <span class="n">y_axis_values</span><span class="p">,</span>
    <span class="n">data_array_3d</span><span class="p">,</span>
    <span class="n">x_axis_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">x_axis_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">x_axis_is_unix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">x_axis_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">center_timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">window_duration_seconds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">y_axis_scale_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">y_axis_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">y_axis_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">y_axis_max</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
    <span class="n">z_axis_scale_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">z_axis_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">z_axis_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">z_axis_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">collapse_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">axis_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">instrument_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vertical_lines_unix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># list of unix timestamps to mark</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot a spectrogram by collapsing a 3D data array along an axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_axis_values : array-like</span>
<span class="sd">        1D array for x (horizontal) axis (e.g., time sequence).</span>
<span class="sd">    y_axis_values : array-like</span>
<span class="sd">        1D array for y (vertical) axis (e.g., energy bins).</span>
<span class="sd">    data_array_3d : numpy.ndarray</span>
<span class="sd">        3D data array, e.g. ``(time, angle/pitch, energy)``.</span>
<span class="sd">    x_axis_min, x_axis_max : float, optional</span>
<span class="sd">        Explicit x-axis clipping bounds before plotting.</span>
<span class="sd">    x_axis_is_unix : bool, default True</span>
<span class="sd">        If ``True``, x-axis treated as UNIX seconds and converted to dates.</span>
<span class="sd">    x_axis_label : str, optional</span>
<span class="sd">        Custom x-axis label (default depends on ``x_axis_is_unix``).</span>
<span class="sd">    center_timestamp : float, optional</span>
<span class="sd">        Center of requested zoom window (UNIX seconds).</span>
<span class="sd">    window_duration_seconds : float, optional</span>
<span class="sd">        Duration of zoom window; both must be provided for zoom to apply.</span>
<span class="sd">    y_axis_scale_function : {&#39;linear&#39;, &#39;log&#39;}, optional</span>
<span class="sd">        Y-axis scaling; ``None`` behaves as ``&#39;linear&#39;``.</span>
<span class="sd">    y_axis_label : str, optional</span>
<span class="sd">        Y-axis label text.</span>
<span class="sd">    y_axis_min, y_axis_max : float, default 0, 4000</span>
<span class="sd">        Y-axis clipping range applied before filtering / plotting.</span>
<span class="sd">    z_axis_scale_function : {&#39;linear&#39;, &#39;log&#39;}, optional</span>
<span class="sd">        Color scale mode; ``None`` behaves as ``&#39;linear&#39;``.</span>
<span class="sd">    z_axis_min, z_axis_max : float, optional</span>
<span class="sd">        Optional color scale bounds (percentiles chosen if omitted).</span>
<span class="sd">    z_axis_label : str, optional</span>
<span class="sd">        Colorbar label text.</span>
<span class="sd">    collapse_axis : int, default 1</span>
<span class="sd">        Axis index along which to collapse the 3D data array.</span>
<span class="sd">    colormap : str, default &#39;viridis&#39;</span>
<span class="sd">        Matplotlib colormap name.</span>
<span class="sd">    axis_object : matplotlib.axes.Axes, optional</span>
<span class="sd">        Existing axes to draw into; if ``None`` a new figure/axes created.</span>
<span class="sd">    instrument_label : str, optional</span>
<span class="sd">        Title string applied to the axes.</span>
<span class="sd">    vertical_lines_unix : list of float, optional</span>
<span class="sd">        UNIX timestamps to annotate with vertical lines.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    axis_object : matplotlib.axes.Axes or None</span>
<span class="sd">        The axis object used for plotting (``None`` if no data plotted).</span>
<span class="sd">    x_axis_plot : numpy.ndarray or None</span>
<span class="sd">        X values actually used (possibly filtered / converted), or ``None`` if skipped.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Log the function call and key parameters for debugging</span>
    <span class="n">log_message</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[DEBUG] make_spectrogram: y_axis_scale_function=</span><span class="si">{</span><span class="n">y_axis_scale_function</span><span class="si">}</span><span class="s2">, z_axis_scale_function=</span><span class="si">{</span><span class="n">z_axis_scale_function</span><span class="si">}</span><span class="s2">, z_axis_min=</span><span class="si">{</span><span class="n">z_axis_min</span><span class="si">}</span><span class="s2">, z_axis_max=</span><span class="si">{</span><span class="n">z_axis_max</span><span class="si">}</span><span class="s2">, colormap=</span><span class="si">{</span><span class="n">colormap</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Convert input arrays to numpy arrays for consistency</span>
    <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_axis_values</span><span class="p">)</span>
    <span class="n">y_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_axis_values</span><span class="p">)</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_array_3d</span><span class="p">)</span>

    <span class="c1"># Collapse the 3D data array along the specified axis (e.g., sum over pitch angle)</span>
    <span class="n">collapsed_matrix</span> <span class="o">=</span> <span class="n">COLLAPSE_FUNCTION</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">collapse_axis</span><span class="p">)</span>

    <span class="c1"># Mask out columns that are all NaN and restrict to valid energy range</span>
    <span class="n">nan_column_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">collapsed_matrix</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">valid_energy_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_axis</span> <span class="o">&gt;=</span> <span class="n">y_axis_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_axis</span> <span class="o">&lt;=</span> <span class="n">y_axis_max</span><span class="p">)</span>
    <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">nan_column_mask</span> <span class="o">&amp;</span> <span class="n">valid_energy_mask</span>
    <span class="n">collapsed_matrix</span> <span class="o">=</span> <span class="n">collapsed_matrix</span><span class="p">[:,</span> <span class="n">combined_mask</span><span class="p">]</span>
    <span class="n">y_axis</span> <span class="o">=</span> <span class="n">y_axis</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">collapsed_matrix</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y_axis</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;[WARNING] All energy bins were filtered out. No data to plot.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Ensure y-axis is increasing (for plotting)</span>
    <span class="k">if</span> <span class="n">y_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">y_axis</span> <span class="o">=</span> <span class="n">y_axis</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">collapsed_matrix</span> <span class="o">=</span> <span class="n">collapsed_matrix</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># If a zoom window is specified, restrict to that window</span>
    <span class="k">if</span> <span class="n">center_timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">window_duration_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">half_window</span> <span class="o">=</span> <span class="n">window_duration_seconds</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">left_bound</span> <span class="o">=</span> <span class="n">center_timestamp</span> <span class="o">-</span> <span class="n">half_window</span>
        <span class="n">right_bound</span> <span class="o">=</span> <span class="n">center_timestamp</span> <span class="o">+</span> <span class="n">half_window</span>
        <span class="n">zoom_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_axis</span> <span class="o">&gt;=</span> <span class="n">left_bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_axis</span> <span class="o">&lt;=</span> <span class="n">right_bound</span><span class="p">)</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="n">x_axis</span><span class="p">[</span><span class="n">zoom_mask</span><span class="p">]</span>
        <span class="n">collapsed_matrix</span> <span class="o">=</span> <span class="n">collapsed_matrix</span><span class="p">[</span><span class="n">zoom_mask</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Restrict to specified x-axis min/max if provided</span>
    <span class="k">if</span> <span class="n">x_axis_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">x_axis_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_axis_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_mask</span> <span class="o">&amp;=</span> <span class="n">x_axis</span> <span class="o">&gt;=</span> <span class="n">x_axis_min</span>
        <span class="k">if</span> <span class="n">x_axis_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_mask</span> <span class="o">&amp;=</span> <span class="n">x_axis</span> <span class="o">&lt;=</span> <span class="n">x_axis_max</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="n">x_axis</span><span class="p">[</span><span class="n">x_mask</span><span class="p">]</span>
        <span class="n">collapsed_matrix</span> <span class="o">=</span> <span class="n">collapsed_matrix</span><span class="p">[</span><span class="n">x_mask</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Convert x-axis to matplotlib date format if using unix timestamps</span>
    <span class="k">if</span> <span class="n">x_axis_is_unix</span><span class="p">:</span>
        <span class="n">x_axis_datetime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_axis</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">x_axis_plot</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span><span class="n">x_axis_datetime</span><span class="p">)</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="n">x_axis_label</span> <span class="k">if</span> <span class="n">x_axis_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Time (UTC)&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_axis_plot</span> <span class="o">=</span> <span class="n">x_axis</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="n">x_axis_label</span> <span class="k">if</span> <span class="n">x_axis_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;X&quot;</span>

    <span class="c1"># Create a new figure and axis if not provided</span>
    <span class="k">if</span> <span class="n">axis_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">PLOT_FIGURE_WIDTH_INCHES</span><span class="p">,</span> <span class="n">PLOT_FIGURE_HEIGHT_INCHES</span><span class="p">))</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">axis_object</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">axis_object</span><span class="o">.</span><span class="n">figure</span>

    <span class="c1"># Transpose matrix for plotting (so y-axis is vertical)</span>
    <span class="n">matrix_plot</span> <span class="o">=</span> <span class="n">collapsed_matrix</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Set x-axis limits to zoom window if specified, otherwise to full range</span>
    <span class="k">if</span> <span class="n">center_timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">window_duration_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x_axis_is_unix</span><span class="p">:</span>
            <span class="n">left_num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">date2num</span><span class="p">(</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
                        <span class="n">center_timestamp</span> <span class="o">-</span> <span class="n">window_duration_seconds</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">right_num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">date2num</span><span class="p">(</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
                        <span class="n">center_timestamp</span> <span class="o">+</span> <span class="n">window_duration_seconds</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">axis_object</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left_num</span><span class="p">,</span> <span class="n">right_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis_object</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span>
                <span class="n">center_timestamp</span> <span class="o">-</span> <span class="n">window_duration_seconds</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">center_timestamp</span> <span class="o">+</span> <span class="n">window_duration_seconds</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis_object</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_axis_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_axis_plot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># If no data remains after filtering, skip plotting</span>
    <span class="k">if</span> <span class="n">matrix_plot</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;[WARNING] No data to plot after filtering. Skipping plot.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Set colorbar min/max if not provided</span>
    <span class="k">if</span> <span class="n">z_axis_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z_axis_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">matrix_plot</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">z_axis_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z_axis_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">matrix_plot</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>

    <span class="c1"># Find the smallest positive value for safe log scaling</span>
    <span class="n">finite_positive</span> <span class="o">=</span> <span class="n">matrix_plot</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">matrix_plot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">matrix_plot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">safe_vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">finite_positive</span><span class="p">)</span> <span class="k">if</span> <span class="n">finite_positive</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1e-10</span>

    <span class="c1"># Plot with log colorbar if requested, masking non-positive values</span>
    <span class="k">if</span> <span class="n">z_axis_scale_function</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">matrix_plot</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">z_axis_min</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">z_axis_max</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">z_axis_min</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">z_axis_max</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">z_axis_max</span> <span class="o">&gt;</span> <span class="n">z_axis_min</span>
        <span class="p">):</span>
            <span class="n">log_message</span><span class="p">(</span>
                <span class="s2">&quot;[WARNING] Non-positive values found in matrix for log colorbar. Masking to z_axis_min and enforcing log scale.&quot;</span>
            <span class="p">)</span>
        <span class="n">z_axis_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">z_axis_min</span><span class="p">,</span> <span class="n">safe_vmin</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">))</span>
        <span class="n">z_axis_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">z_axis_max</span><span class="p">)</span>
        <span class="c1"># Mask all non-positive and non-finite values for log scale</span>
        <span class="n">matrix_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">matrix_plot</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">matrix_plot</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">z_axis_min</span><span class="p">,</span> <span class="n">matrix_plot</span>
        <span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">z_axis_min</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z_axis_max</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">axis_object</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">matrix_plot</span><span class="p">,</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">x_axis_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_axis_plot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
            <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Compute tick marks for every integer power of 10 in range</span>
        <span class="n">min_exponent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">z_axis_min</span><span class="p">)))</span>
        <span class="n">max_exponent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">z_axis_max</span><span class="p">)))</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mi">10</span><span class="o">**</span><span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_exponent</span><span class="p">,</span> <span class="n">max_exponent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">z_axis_min</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">**</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">z_axis_max</span>
        <span class="p">]</span>
        <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] make_spectrogram: log colorbar ticks: </span><span class="si">{</span><span class="n">ticks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">log_tick_formatter</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="n">exponent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">exponent</span><span class="p">):</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;$10^</span><span class="se">{{</span><span class="si">{</span><span class="n">exponent</span><span class="si">}</span><span class="se">}}</span><span class="s2">$&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Create the colorbar with custom ticks and formatter</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
            <span class="n">im</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axis_object</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">z_axis_label</span> <span class="k">if</span> <span class="n">z_axis_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Counts&quot;</span><span class="p">,</span>
            <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">log_tick_formatter</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Linear colorbar: mask NaN and inf values, set vmin/vmax</span>
        <span class="n">z_axis_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">z_axis_min</span><span class="p">)</span>
        <span class="n">z_axis_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">z_axis_max</span><span class="p">)</span>
        <span class="n">matrix_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">matrix_plot</span><span class="p">),</span> <span class="n">z_axis_min</span><span class="p">,</span> <span class="n">matrix_plot</span><span class="p">)</span>
        <span class="n">matrix_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isneginf</span><span class="p">(</span><span class="n">matrix_plot</span><span class="p">),</span> <span class="n">z_axis_min</span><span class="p">,</span> <span class="n">matrix_plot</span><span class="p">)</span>
        <span class="n">matrix_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isposinf</span><span class="p">(</span><span class="n">matrix_plot</span><span class="p">),</span> <span class="n">z_axis_max</span><span class="p">,</span> <span class="n">matrix_plot</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">z_axis_min</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">z_axis_max</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">z_axis_max</span> <span class="o">&gt;</span> <span class="n">z_axis_min</span>
        <span class="p">):</span>
            <span class="n">z_axis_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">matrix_plot</span><span class="p">))</span>
            <span class="n">z_axis_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">matrix_plot</span><span class="p">))</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">axis_object</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">matrix_plot</span><span class="p">,</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">x_axis_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_axis_plot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">z_axis_min</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">z_axis_max</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Create the colorbar for linear scale</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
            <span class="n">im</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axis_object</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">z_axis_label</span> <span class="k">if</span> <span class="n">z_axis_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Counts&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Set axis labels and title</span>
    <span class="n">axis_object</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
    <span class="n">axis_object</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_axis_label</span> <span class="k">if</span> <span class="n">y_axis_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Energy (eV)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">instrument_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axis_object</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">instrument_label</span><span class="p">)</span>

    <span class="c1"># Configure y-axis ticks and scale</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_axis</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y_axis_scale_function</span> <span class="o">!=</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="c1"># For linear y-axis, set ticks at reasonable intervals</span>
            <span class="n">y_max_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_axis_max</span><span class="p">)</span>
            <span class="n">y_max_digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_max_str</span><span class="p">)</span>
            <span class="n">y_first_digit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_max_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">y_second_digit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_max_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">y_second_digit</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">step_size</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">y_max_digits</span>
                <span class="n">y_max_tick</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_first_digit</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">y_max_digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step_size</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">y_max_digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">y_max_tick</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_first_digit</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">y_max_digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">i</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_axis_min</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_max_tick</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">y_max_tick</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.1</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axis_object</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
                <span class="n">axis_object</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For log y-axis, set scale to log</span>
            <span class="n">axis_object</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

    <span class="c1"># Format x-axis as time if using unix timestamps</span>
    <span class="k">if</span> <span class="n">x_axis_is_unix</span><span class="p">:</span>
        <span class="n">x_limits</span> <span class="o">=</span> <span class="n">axis_object</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">left_datetime</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">x_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">right_datetime</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">x_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">displayed_time_range_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_datetime</span> <span class="o">-</span> <span class="n">left_datetime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">displayed_time_range_seconds</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">:</span>
            <span class="n">axis_object</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span>
                <span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis_object</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span>
                <span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%H:%M&quot;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Draw vertical lines for orbit boundaries or other events if provided</span>
    <span class="k">if</span> <span class="n">vertical_lines_unix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertical_lines_unix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x_axis_is_unix</span><span class="p">:</span>
            <span class="n">vertical_lines_plot</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="n">vertical_lines_unix</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">x_min_plot</span> <span class="o">=</span> <span class="n">x_axis_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x_max_plot</span> <span class="o">=</span> <span class="n">x_axis_plot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vertical_lines_plot</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertical_lines_plot</span> <span class="k">if</span> <span class="n">x_min_plot</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">x_max_plot</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vertical_lines_plot</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertical_lines_unix</span> <span class="k">if</span> <span class="n">x_axis_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">x_axis_plot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">for</span> <span class="n">vertical_line</span> <span class="ow">in</span> <span class="n">vertical_lines_plot</span><span class="p">:</span>
            <span class="c1"># Draw a thick black line under a thinner red line for visibility</span>
            <span class="n">axis_object</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                <span class="n">vertical_line</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">axis_object</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                <span class="n">vertical_line</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Set tick parameters for better readability</span>
    <span class="n">axis_object</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span>
        <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">TICK_LABEL_FONT_SIZE</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">axis_object</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span>
        <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">TICK_LABEL_FONT_SIZE</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">TICK_LABEL_FONT_SIZE</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span>
        <span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">TICK_LABEL_FONT_SIZE</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="c1"># Set axis label font sizes</span>
    <span class="n">axis_object</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">AXIS_LABEL_FONT_SIZE</span><span class="p">)</span>
    <span class="n">axis_object</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">AXIS_LABEL_FONT_SIZE</span><span class="p">)</span>
    <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Counts&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">AXIS_LABEL_FONT_SIZE</span><span class="p">)</span>

    <span class="c1"># Return the axis and the x-axis values used for plotting</span>
    <span class="k">return</span> <span class="n">axis_object</span><span class="p">,</span> <span class="n">x_axis_plot</span></div>



<div class="viewcode-block" id="generic_plot_spectrogram_set">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.generic_plot_spectrogram_set">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generic_plot_spectrogram_set</span><span class="p">(</span>
    <span class="n">datasets</span><span class="p">,</span>
    <span class="n">collapse_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">zoom_center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_window_seconds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vertical_lines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">x_is_unix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">y_scale</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="n">z_scale</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">figure_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">y_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">y_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">z_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">z_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot a vertical stack of generic spectrograms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datasets : list of dict</span>
<span class="sd">        Each dict requires keys ``&#39;x&#39;``, ``&#39;y&#39;``, ``&#39;data&#39;`` and may include optional keys:</span>
<span class="sd">        ``&#39;label&#39;``, ``&#39;y_label&#39;``, ``&#39;z_label&#39;``, ``&#39;y_min&#39;``, ``&#39;y_max&#39;``, ``&#39;z_min&#39;``, ``&#39;z_max&#39;``.</span>
<span class="sd">    collapse_axis : int, default 1</span>
<span class="sd">        Axis index of the 3D array collapsed prior to plotting.</span>
<span class="sd">    zoom_center : float, optional</span>
<span class="sd">        Center (UNIX time) for zoom column when used.</span>
<span class="sd">    zoom_window_seconds : float, optional</span>
<span class="sd">        Duration of zoom window (seconds) when ``zoom_center`` provided.</span>
<span class="sd">    vertical_lines : list of float, optional</span>
<span class="sd">        UNIX timestamps to annotate with vertical lines.</span>
<span class="sd">    x_is_unix : bool, default True</span>
<span class="sd">        If ``True``, x values are treated as UNIX seconds and formatted.</span>
<span class="sd">    y_scale : {&#39;linear&#39;, &#39;log&#39;}, default &#39;linear&#39;</span>
<span class="sd">        Y-axis scaling mode.</span>
<span class="sd">    z_scale : {&#39;linear&#39;, &#39;log&#39;}, default &#39;linear&#39;</span>
<span class="sd">        Color (intensity) scale mode.</span>
<span class="sd">    colormap : str, default &#39;viridis&#39;</span>
<span class="sd">        Matplotlib colormap name.</span>
<span class="sd">    figure_title : str, optional</span>
<span class="sd">        Figure-level title (sup-title).</span>
<span class="sd">    show : bool, default False</span>
<span class="sd">        If ``True``, display interactively (requires GUI backend).</span>
<span class="sd">    y_min : float, optional</span>
<span class="sd">        Global Y min fallback when per-row not supplied. Defaults to 0 if omitted and per-row missing.</span>
<span class="sd">    y_max : float, optional</span>
<span class="sd">        Global Y max fallback when per-row not supplied. If both global and per-row absent, inferred.</span>
<span class="sd">    z_min : float, optional</span>
<span class="sd">        Global colorbar lower bound fallback.</span>
<span class="sd">    z_max : float, optional</span>
<span class="sd">        Global colorbar upper bound fallback.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        ``(fig, canvas)`` or ``(None, None)`` if ``datasets`` is empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)))</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row_index</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
        <span class="n">axis_obj</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_obj</span><span class="p">)</span>
        <span class="c1"># Resolve per-dataset ranges with global fallback (row-specific wins)</span>
        <span class="n">dataset_y_min</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_min&quot;</span><span class="p">,</span> <span class="n">y_min</span><span class="p">)</span>
        <span class="n">dataset_y_max</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_max&quot;</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
        <span class="n">dataset_z_min</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z_min&quot;</span><span class="p">,</span> <span class="n">z_min</span><span class="p">)</span>
        <span class="n">dataset_z_max</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z_max&quot;</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span>
        <span class="c1"># Compute fallback y max from provided y array if not given</span>
        <span class="n">inferred_y_max</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dataset_y_max</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">dataset_y_max</span>
        <span class="p">)</span>
        <span class="n">make_spectrogram</span><span class="p">(</span>
            <span class="n">x_axis_values</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
            <span class="n">y_axis_values</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
            <span class="n">data_array_3d</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
            <span class="n">collapse_axis</span><span class="o">=</span><span class="n">collapse_axis</span><span class="p">,</span>
            <span class="n">center_timestamp</span><span class="o">=</span><span class="n">zoom_center</span><span class="p">,</span>
            <span class="n">window_duration_seconds</span><span class="o">=</span><span class="n">zoom_window_seconds</span><span class="p">,</span>
            <span class="n">x_axis_is_unix</span><span class="o">=</span><span class="n">x_is_unix</span><span class="p">,</span>
            <span class="n">y_axis_scale_function</span><span class="o">=</span><span class="n">y_scale</span><span class="p">,</span>
            <span class="n">z_axis_scale_function</span><span class="o">=</span><span class="n">z_scale</span><span class="p">,</span>
            <span class="n">y_axis_min</span><span class="o">=</span><span class="n">dataset_y_min</span> <span class="k">if</span> <span class="n">dataset_y_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">y_axis_max</span><span class="o">=</span><span class="n">inferred_y_max</span> <span class="k">if</span> <span class="n">inferred_y_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">4000</span><span class="p">,</span>
            <span class="n">z_axis_min</span><span class="o">=</span><span class="n">dataset_z_min</span><span class="p">,</span>
            <span class="n">z_axis_max</span><span class="o">=</span><span class="n">dataset_z_max</span><span class="p">,</span>
            <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
            <span class="n">y_axis_label</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_label&quot;</span><span class="p">,</span> <span class="s2">&quot;Energy (eV)&quot;</span><span class="p">),</span>
            <span class="n">z_axis_label</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z_label&quot;</span><span class="p">,</span> <span class="s2">&quot;Counts&quot;</span><span class="p">),</span>
            <span class="n">x_axis_label</span><span class="o">=</span><span class="s2">&quot;Time (UTC)&quot;</span> <span class="k">if</span> <span class="n">x_is_unix</span> <span class="k">else</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_label&quot;</span><span class="p">),</span>
            <span class="n">vertical_lines_unix</span><span class="o">=</span><span class="n">vertical_lines</span><span class="p">,</span>
            <span class="n">axis_object</span><span class="o">=</span><span class="n">axis_obj</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">):</span>
            <span class="n">axis_obj</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">figure_title</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">figure_title</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">canvas</span></div>



<div class="viewcode-block" id="generic_batch_plot">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.generic_batch_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generic_batch_plot</span><span class="p">(</span>
    <span class="n">items</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">,</span>
    <span class="n">build_datasets_fn</span><span class="p">,</span>
    <span class="n">zoom_center_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_window_seconds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vertical_lines_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">y_scale</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="n">z_scale</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">progress_json_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PLOTTING_PROGRESS_JSON_PATH</span><span class="p">,</span>
    <span class="n">ignore_progress_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">flush_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">log_flush_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">install_signal_handlers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic batch runner for plotting datasets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    items : iterable</span>
<span class="sd">        Iterable of item identifiers (any ``repr``-able objects).</span>
<span class="sd">    output_dir : str</span>
<span class="sd">        Base output directory; plots saved under ``output_dir/&lt;item&gt;/generic.png``.</span>
<span class="sd">    build_datasets_fn : callable</span>
<span class="sd">        Callable returning ``list[dict]`` describing datasets for an item.</span>
<span class="sd">    zoom_center_fn : callable, optional</span>
<span class="sd">        Callable mapping item -&gt; center UNIX time (or ``None``) for zoom.</span>
<span class="sd">    zoom_window_seconds : float, optional</span>
<span class="sd">        Duration of zoom window in seconds.</span>
<span class="sd">    vertical_lines_fn : callable, optional</span>
<span class="sd">        Callable mapping item -&gt; list[float] UNIX timestamps (or ``None``).</span>
<span class="sd">    y_scale : {&#39;linear&#39;, &#39;log&#39;}, default &#39;linear&#39;</span>
<span class="sd">        Y-axis scaling for all rows.</span>
<span class="sd">    z_scale : {&#39;linear&#39;, &#39;log&#39;}, default &#39;linear&#39;</span>
<span class="sd">        Color scaling for all rows.</span>
<span class="sd">    colormap : str, default &#39;viridis&#39;</span>
<span class="sd">        Matplotlib colormap name.</span>
<span class="sd">    max_workers : int, default 2</span>
<span class="sd">        Number of parallel worker processes.</span>
<span class="sd">    progress_json_path : str, default PLOTTING_PROGRESS_JSON_PATH</span>
<span class="sd">        Path to progress JSON (resumable state). Created/updated as needed.</span>
<span class="sd">    ignore_progress_json : bool, default False</span>
<span class="sd">        If ``True``, skip reading existing progress prior to execution.</span>
<span class="sd">    flush_batch_size : int, default 10</span>
<span class="sd">        Progress/log batch size; values &lt; 1 coerced to 1. Final partial batch flushed.</span>
<span class="sd">    log_flush_batch_size : int, optional</span>
<span class="sd">        Explicit log batch size; if ``None`` reuse ``flush_batch_size``.</span>
<span class="sd">    install_signal_handlers : bool, default True</span>
<span class="sd">        When True, a temporary SIGINT handler is installed (restored on exit) to</span>
<span class="sd">        enable graceful interruption (progress &amp; log flush). Set False in embedded</span>
<span class="sd">        environments if altering the global handler causes side-effects.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of tuple</span>
<span class="sd">        Sequence of ``(item, status)`` with ``status`` in {``&#39;ok&#39;``, ``&#39;no_data&#39;``, ``&#39;error&#39;``}.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * Logging is buffered and force-flushed at completion.</span>
<span class="sd">    * Progress JSON contains simple lists of completed, error, and no-data items.</span>
<span class="sd">    * Items are identified via ``repr(item)`` for data-agnostic persistence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">previous_sigint</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">install_signal_handlers</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">previous_sigint</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">_sigint_handler</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_gbp_sig_setup_exc</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[WARN] Could not install temporary SIGINT handler: </span><span class="si">{</span><span class="n">_gbp_sig_setup_exc</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="n">flush_batch_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">flush_batch_size</span><span class="p">))</span>
    <span class="n">configure_log_batch</span><span class="p">(</span><span class="n">log_flush_batch_size</span> <span class="ow">or</span> <span class="n">flush_batch_size</span><span class="p">)</span>

    <span class="c1"># Step: Load prior progress (if any)</span>
    <span class="n">progress_state</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Ordered list of repr(item) for successfully completed items.</span>
        <span class="s2">&quot;completed_items&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="c1"># Items that raised exceptions inside the worker.</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="c1"># Items that returned logically empty datasets (no plots generated).</span>
        <span class="s2">&quot;no_data&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="c1"># Sequential index counter for processed items (0-based).</span>
        <span class="s2">&quot;last_index&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="c1"># For future schema migrations.</span>
        <span class="s2">&quot;schema_version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ignore_progress_json</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">progress_json_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">progress_json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress_in</span><span class="p">:</span>
                <span class="n">loaded</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">progress_in</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loaded</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># Merge known keys</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">progress_state</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">loaded</span><span class="p">:</span>
                        <span class="n">progress_state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">loaded</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">progress_json_read_exception</span><span class="p">:</span>
            <span class="n">log_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[PROGRESS] Failed to read existing progress JSON &#39;</span><span class="si">{</span><span class="n">progress_json_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">progress_json_read_exception</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Step: Determine pending items (skip already completed)</span>
    <span class="n">item_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="n">completed_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">progress_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;completed_items&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">pending_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">item_list</span> <span class="k">if</span> <span class="nb">repr</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">completed_set</span><span class="p">]</span>
    <span class="n">total_pending</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pending_items</span><span class="p">)</span>
    <span class="n">log_message</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[BATCH] Starting generic batch plot with </span><span class="si">{</span><span class="n">total_pending</span><span class="si">}</span><span class="s2"> pending / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">item_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> total items; flush_batch_size=</span><span class="si">{</span><span class="n">flush_batch_size</span><span class="si">}</span><span class="s2"> log_flush_batch_size=</span><span class="si">{</span><span class="n">log_flush_batch_size</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">flush_batch_size</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Step: Define progress JSON flush helper</span>
    <span class="n">pending_progress_write_count</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">0</span>  <span class="c1"># number of in-memory updates since last JSON flush</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_flush_progress</span><span class="p">(</span><span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush progress JSON to disk using batch semantics.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force : bool, default False</span>
<span class="sd">            If True, flush even if the number of pending updates is below the</span>
<span class="sd">            configured batch size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">pending_progress_write_count</span>
        <span class="k">if</span> <span class="n">pending_progress_write_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pending_progress_write_count</span> <span class="o">&gt;=</span> <span class="n">flush_batch_size</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">progress_json_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress_out</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">progress_state</span><span class="p">,</span> <span class="n">progress_out</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">pending_progress_write_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">progress_json_write_exception</span><span class="p">:</span>
                <span class="n">log_error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[PROGRESS] Failed writing progress JSON &#39;</span><span class="si">{</span><span class="n">progress_json_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">progress_json_write_exception</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="c1"># Step: Worker wrapper</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_worker</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="n">build_datasets_fn</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">datasets</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;no_data&quot;</span><span class="p">)</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">zoom_center_fn</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">if</span> <span class="n">zoom_center_fn</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">vlines</span> <span class="o">=</span> <span class="n">vertical_lines_fn</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">if</span> <span class="n">vertical_lines_fn</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">canvas</span> <span class="o">=</span> <span class="n">generic_plot_spectrogram_set</span><span class="p">(</span>
                <span class="n">datasets</span><span class="p">,</span>
                <span class="n">zoom_center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span>
                <span class="n">zoom_window_seconds</span><span class="o">=</span><span class="n">zoom_window_seconds</span><span class="p">,</span>
                <span class="n">vertical_lines</span><span class="o">=</span><span class="n">vlines</span><span class="p">,</span>
                <span class="n">y_scale</span><span class="o">=</span><span class="n">y_scale</span><span class="p">,</span>
                <span class="n">z_scale</span><span class="o">=</span><span class="n">z_scale</span><span class="p">,</span>
                <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
                <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">od</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="s2">&quot;generic.png&quot;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
                <span class="n">close_all_axes_and_clear</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">generic_exception</span><span class="p">:</span>
            <span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[GENERIC-FAIL] Item </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">generic_exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">processed_item_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span>
        <span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">process_pool</span><span class="p">:</span>
        <span class="n">future_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">process_pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_worker</span><span class="p">,</span> <span class="n">item_identifier</span><span class="p">):</span> <span class="n">item_identifier</span>
            <span class="k">for</span> <span class="n">item_identifier</span> <span class="ow">in</span> <span class="n">pending_items</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">finished_future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_map</span><span class="p">):</span>
            <span class="n">original_item_identifier</span> <span class="o">=</span> <span class="n">future_map</span><span class="p">[</span><span class="n">finished_future</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">item_identifier</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">finished_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">generic_batch_future_exception</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
                <span class="n">item_identifier</span> <span class="o">=</span> <span class="n">original_item_identifier</span>
                <span class="n">log_error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[GENERIC-FAIL] Item </span><span class="si">{</span><span class="n">original_item_identifier</span><span class="si">}</span><span class="s2"> outer exception: </span><span class="si">{</span><span class="n">generic_batch_future_exception</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item_identifier</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
            <span class="c1"># Progress classification &amp; state update</span>
            <span class="n">item_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">item_identifier</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ok&quot;</span><span class="p">:</span>
                <span class="n">progress_state</span><span class="p">[</span><span class="s2">&quot;completed_items&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_repr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;no_data&quot;</span><span class="p">:</span>
                <span class="n">progress_state</span><span class="p">[</span><span class="s2">&quot;no_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_repr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">progress_state</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_repr</span><span class="p">)</span>
            <span class="n">processed_item_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">progress_state</span><span class="p">[</span><span class="s2">&quot;last_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_item_count</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">pending_progress_write_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">_flush_progress</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Step: Final flushes</span>
    <span class="n">_flush_progress</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_flush_log_buffer</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">log_message</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="s2">&quot;[BATCH] Completed generic batch plot: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">processed_item_count</span><span class="si">}</span><span class="s2"> processed (ok=</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;no_data=</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;no_data&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;error=</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">),</span>
        <span class="n">force_flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Restore prior handler if we replaced it</span>
    <span class="k">if</span> <span class="n">install_signal_handlers</span> <span class="ow">and</span> <span class="n">previous_sigint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">previous_sigint</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_gbp_sig_restore_exc</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[WARN] Could not restore original SIGINT handler: </span><span class="si">{</span><span class="n">_gbp_sig_restore_exc</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="generic_plot_multirow_optional_zoom">
<a class="viewcode-back" href="../modules.html#batch_multi_plot_spectrogram.generic_plot_multirow_optional_zoom">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generic_plot_multirow_optional_zoom</span><span class="p">(</span>
    <span class="n">datasets</span><span class="p">,</span>
    <span class="n">vertical_lines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_duration_minutes</span><span class="o">=</span><span class="mf">6.25</span><span class="p">,</span>
    <span class="n">y_scale</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="n">z_scale</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">row_label_pad</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">row_label_rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="n">y_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">y_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">z_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">z_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render a multi-row spectrogram grid with an optional zoom column.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datasets : list of dict</span>
<span class="sd">        Each dict must contain keys:</span>

<span class="sd">        * ``&#39;x&#39;``  1D UNIX epoch seconds (float) array</span>
<span class="sd">        * ``&#39;y&#39;``  1D energy (eV) array (unfiltered, 04000 typical)</span>
<span class="sd">        * ``&#39;data&#39;``  3D ndarray that can be collapsed (time, pitch/angle, energy)</span>

<span class="sd">        Optional per-row keys (all honored when present):</span>

<span class="sd">        * ``&#39;label&#39;``  Row label placed on the left (rotated)</span>
<span class="sd">        * ``&#39;y_label&#39;``  Units label for y-axis (default: ``&#39;Energy (eV)&#39;``)</span>
<span class="sd">        * ``&#39;z_label&#39;``  Color scale label (default: ``&#39;Counts&#39;``)</span>
<span class="sd">        * ``&#39;y_min&#39;`` / ``&#39;y_max&#39;``  Energy bounds (overrides global ``y_min`` / ``y_max`` args)</span>
<span class="sd">        * ``&#39;z_min&#39;`` / ``&#39;z_max&#39;``  Color bounds (overrides global ``z_min`` / ``z_max`` args)</span>
<span class="sd">        * ``&#39;vmin&#39;`` / ``&#39;vmax&#39;``  Precomputed percentile (or fixed) color bounds used when</span>
<span class="sd">            ``z_min`` / ``z_max`` not provided. (``vmin``/``vmax`` are interpreted as the *row&#39;s*</span>
<span class="sd">            native bounds; global ``z_min`` / ``z_max`` will still clamp if supplied.)</span>
<span class="sd">    vertical_lines : list of float, optional</span>
<span class="sd">        UNIX timestamps defining event/selection markers and potential zoom window.</span>
<span class="sd">    zoom_duration_minutes : float, default 6.25</span>
<span class="sd">        Desired zoom window length in minutes (may auto-expand to include full marked span).</span>
<span class="sd">    y_scale : {&#39;linear&#39;, &#39;log&#39;}, default &#39;linear&#39;</span>
<span class="sd">        Y-axis scaling.</span>
<span class="sd">    z_scale : {&#39;linear&#39;, &#39;log&#39;}, default &#39;linear&#39;</span>
<span class="sd">        Color (intensity) scale.</span>
<span class="sd">    colormap : str, default &#39;viridis&#39;</span>
<span class="sd">        Matplotlib colormap.</span>
<span class="sd">    show : bool, default False</span>
<span class="sd">        If ``True``, display interactively.</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        Figure suptitle.</span>
<span class="sd">    row_label_pad : int, default 50</span>
<span class="sd">        Padding for row labels.</span>
<span class="sd">    row_label_rotation : int, default 90</span>
<span class="sd">        Rotation angle (degrees) for row labels.</span>
<span class="sd">    y_min, y_max, z_min, z_max : float, optional</span>
<span class="sd">        Global override bounds applied uniformly when provided. Any per-row</span>
<span class="sd">        ``y_min`` / ``y_max`` / ``z_min`` / ``z_max`` in a dataset dict take</span>
<span class="sd">        precedence. When neither global nor per-row color bounds are supplied</span>
<span class="sd">        the function relies on each dataset&#39;s ``vmin`` / ``vmax`` (if present)</span>
<span class="sd">        else falls back to internal percentile selection in lower-level calls.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        ``(fig, canvas)`` or ``(None, None)`` if ``datasets`` is empty.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * Determines need for a zoom column dynamically: only rendered if at least</span>
<span class="sd">        one dataset contains non-NaN values inside the computed zoom window.</span>
<span class="sd">    * Y-axis and colorbar labels default to &quot;Energy (eV)&quot; and &quot;Counts&quot; when a</span>
<span class="sd">        dataset omits explicit ``y_label`` / ``z_label`` (defaults originate in</span>
<span class="sd">        ``generic_plot_spectrogram_set`` / dataset assembly).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="c1"># Determine zoom window &amp; whether needed</span>
    <span class="n">zoom_needed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">center_value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">vertical_lines</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertical_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertical_lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">center_value</span> <span class="o">=</span> <span class="n">vertical_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">zoom_duration_minutes</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">center_value</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">vertical_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vertical_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">min_window</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vertical_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">vertical_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1.5</span>
            <span class="n">requested_window</span> <span class="o">=</span> <span class="n">zoom_duration_minutes</span> <span class="o">*</span> <span class="mi">60</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">requested_window</span><span class="p">,</span> <span class="n">min_window</span><span class="p">)</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">center_value</span> <span class="o">-</span> <span class="n">duration</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">center_value</span> <span class="o">+</span> <span class="n">duration</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
            <span class="n">mask_zoom</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">)</span>
            <span class="c1"># Require some non-NaN data inside window</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">mask_zoom</span><span class="p">])):</span>
                <span class="n">zoom_needed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
    <span class="n">number_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
    <span class="n">number_columns</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">zoom_needed</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">number_columns</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">number_rows</span><span class="p">))</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">number_rows</span><span class="p">,</span> <span class="n">number_columns</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_columns</span><span class="p">):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span>
                <span class="n">number_rows</span><span class="p">,</span> <span class="n">number_columns</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">number_columns</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>
    <span class="c1"># Plot rows</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
        <span class="n">data3d</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vmin&quot;</span><span class="p">)</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vmax&quot;</span><span class="p">)</span>
        <span class="c1"># Full</span>
        <span class="n">make_spectrogram</span><span class="p">(</span>
            <span class="n">x_axis_values</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
            <span class="n">y_axis_values</span><span class="o">=</span><span class="n">energy</span><span class="p">,</span>
            <span class="n">data_array_3d</span><span class="o">=</span><span class="n">data3d</span><span class="p">,</span>
            <span class="n">collapse_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">x_axis_min</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">x_axis_max</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">x_axis_is_unix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">instrument_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">y_axis_scale_function</span><span class="o">=</span><span class="n">y_scale</span><span class="p">,</span>
            <span class="n">z_axis_scale_function</span><span class="o">=</span><span class="n">z_scale</span><span class="p">,</span>
            <span class="n">vertical_lines_unix</span><span class="o">=</span><span class="n">vertical_lines</span><span class="p">,</span>
            <span class="n">z_axis_min</span><span class="o">=</span><span class="n">vmin</span> <span class="k">if</span> <span class="n">z_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">z_min</span><span class="p">,</span>
            <span class="n">z_axis_max</span><span class="o">=</span><span class="n">vmax</span> <span class="k">if</span> <span class="n">z_max</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">z_max</span><span class="p">,</span>
            <span class="n">axis_object</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Zoom</span>
        <span class="k">if</span> <span class="n">number_columns</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">make_spectrogram</span><span class="p">(</span>
                <span class="n">x_axis_values</span><span class="o">=</span><span class="n">times</span><span class="p">,</span>
                <span class="n">y_axis_values</span><span class="o">=</span><span class="n">energy</span><span class="p">,</span>
                <span class="n">data_array_3d</span><span class="o">=</span><span class="n">data3d</span><span class="p">,</span>
                <span class="n">collapse_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">center_timestamp</span><span class="o">=</span><span class="n">center_value</span><span class="p">,</span>
                <span class="n">window_duration_seconds</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                <span class="n">x_axis_is_unix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">instrument_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">y_axis_scale_function</span><span class="o">=</span><span class="n">y_scale</span><span class="p">,</span>
                <span class="n">z_axis_scale_function</span><span class="o">=</span><span class="n">z_scale</span><span class="p">,</span>
                <span class="n">vertical_lines_unix</span><span class="o">=</span><span class="n">vertical_lines</span><span class="p">,</span>
                <span class="n">z_axis_min</span><span class="o">=</span><span class="n">vmin</span> <span class="k">if</span> <span class="n">z_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">z_min</span><span class="p">,</span>
                <span class="n">z_axis_max</span><span class="o">=</span><span class="n">vmax</span> <span class="k">if</span> <span class="n">z_max</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">z_max</span><span class="p">,</span>
                <span class="n">axis_object</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="c1"># Row labels</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">AXIS_LABEL_FONT_SIZE</span><span class="p">,</span>
            <span class="n">rotation</span><span class="o">=</span><span class="n">row_label_rotation</span><span class="p">,</span>
            <span class="n">labelpad</span><span class="o">=</span><span class="n">row_label_pad</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># Column headers</span>
    <span class="k">if</span> <span class="n">number_columns</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">AXIS_LABEL_FONT_SIZE</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Zoomed&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">AXIS_LABEL_FONT_SIZE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">AXIS_LABEL_FONT_SIZE</span><span class="p">)</span>
    <span class="c1"># Title</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">AXIS_LABEL_FONT_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Timespan annotation (use first dataset times)</span>
    <span class="n">base_times</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">base_times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">base_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">data_timespan_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Data timespan: </span><span class="si">{</span><span class="n">t0</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">t1</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> UTC&quot;</span>
    <span class="n">marked_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">vertical_lines</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertical_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">vertical_lines</span><span class="p">),</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">vertical_lines</span><span class="p">),</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">marked_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Marked range: </span><span class="si">{</span><span class="n">v0</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">v1</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> UTC&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.18</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">data_timespan_str</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">marked_str</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.5</span><span class="p">,</span>
            <span class="mf">0.045</span><span class="p">,</span>
            <span class="n">marked_str</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">canvas</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Configurable Spectrograms</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Module Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../batching_and_logging.html">Batching and Buffered Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../generic_batch_plotting.html">Generic Batch Spectrogram Plotting</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Ev Hansen.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>